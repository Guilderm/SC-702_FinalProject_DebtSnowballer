@using DebtSnowballer.Client.ClientSideServices.FinancialFreedom
@inject IFinancialFreedomPlanner FinancialFreedomPlanner
@inject NavigationManager NavigationManager

<h1>Amortization Schedule</h1>


<div>
	<MudChart ChartType="ChartType.Line" ChartSeries="@Series" @bind-SelectedIndex="_index" XAxisLabels="@XAxisLabels" Width="100%" Height="350px"></MudChart>
	<MudText Typo="Typo.h6">Interest Paid Over Time</MudText>
</div>


@foreach (var plan in DebtPayoffPlan.PaymentPlans)
{
	<h3>Strategy Name: @plan.Key</h3>
	<h4>Loan Details</h4>

	@foreach (ClientSideServices.FinancialFreedom.AmortizationSchedule schedule in plan.Value)
	{
		string currencySymbol = GetCurrencySymbol(schedule.CurrencyCode);

		<h5>
			<br>@schedule.Name
		</h5>
		<p>Loans Currency: @schedule.CurrencyCode</p>
		<p>Annual Interest Rate: @schedule.AnnualInterestRate.ToString("P2")</p>
		<p>Bank Fees: @currencySymbol @schedule.BankFees.ToString("N2")</p>
		<p>Contracted Monthly Payment: @currencySymbol @schedule.ContractedMonthlyPayment.ToString("N2")</p>
		<br>
		<p>Total Interest Paid: @currencySymbol @schedule.TotalInterestPaid.ToString("N2")</p>
		<p>Total Bank Fees Paid: @currencySymbol @schedule.TotalBankFeesPaid.ToString("N2")</p>
		<p>Total Principal Paid: @currencySymbol @schedule.TotalPrincipalPaid.ToString("N2")</p>
		<p>Total ExtraPayment Paid: @currencySymbol @schedule.TotalExtraPayment.ToString("N2")</p>
		<br>
	}


	<table class="table">
		<thead>
		<tr>
			<th>Loan</th>
			<th>Month</th>
			<th>Date</th>
			<th>Interest Paid</th>
			<th>Bank Fees Paid</th>
			<th>Principal Paid</th>
			<th>Accumulated Interest Paid</th>
			<th>Accumulated Bank Fees Paid</th>
			<th>Accumulated Principal Paid</th>
			<th>Accumulated Extra Payment</th>
			<th>Unallocated Payment</th>
			<th>Extra Payment</th>
		</tr>
		</thead>
		<tbody>
		@foreach (PaymentInstallment detail in plan.Value.SelectMany(a => a.PaymentInstallments))
		{
			string currencySymbol = GetCurrencySymbol(detail.EndOfMonthLoanState.CurrencyCode);
			<tr>
				<td>@detail.EndOfMonthLoanState.Name</td>
				<td>@detail.PaymentMonth</td>
				<td>@detail.EndOfMonthLoanState.StartDate.ToString("yyyy-MM")</td>
				<td>@currencySymbol @detail.InterestPaid.ToString("N2")</td>
				<td>@currencySymbol @detail.BankFeesPaid.ToString("N2")</td>
				<td>@currencySymbol @detail.PrincipalPaid.ToString("N2")</td>
				<td>@currencySymbol @detail.AccumulatedInterestPaid.ToString("N2")</td>
				<td>@currencySymbol @detail.AccumulatedBankFeesPaid.ToString("N2")</td>
				<td>@currencySymbol @detail.AccumulatedPrincipalPaid.ToString("N2")</td>
				<td>@currencySymbol @detail.AccumulatedExtraPayment.ToString("N2")</td>
				<td>@currencySymbol @detail.UnallocatedPayment.ToString("N2")</td>
				<td>@currencySymbol @detail.ExtraPayment.ToString("N2")</td>
			</tr>
		}
		</tbody>
	</table>
}

@code {

	private int _index = -1;
	public List<ChartSeries> Series { get; set; } = new();
	public string[] XAxisLabels { get; set; } = { "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec" };

	[Parameter]
	public DebtPayoffPlan DebtPayoffPlan { get; set; }

	[Parameter]
	public Func<string, string> GetCurrencySymbol { get; set; }


	protected override void OnParametersSet()
	{
		PopulateChartData();
	}

	private void PopulateChartData()
	{
	// Clear existing data
		Series.Clear();

	// Create a list to store interest paid data for each strategy
		var interestPaidData = new Dictionary<string, List<double>>();

	// Iterate through payment plans and extract interest paid
		foreach (var plan in DebtPayoffPlan.PaymentPlans)
		{
			string strategyName = plan.Key;
			interestPaidData[strategyName] = new List<double>();

			foreach (PaymentInstallment detail in plan.Value.SelectMany(a => a.PaymentInstallments))
			{
				interestPaidData[strategyName].Add((double)detail.InterestPaid);
			}
		}

		foreach (var item in interestPaidData)
		{
			Series.Add(new ChartSeries { Name = item.Key, Data = item.Value.ToArray() });
		}
	}

}